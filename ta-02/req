KASH-ta02 can be accessed via the API endpoint cash-stock-management/OpenCashStock with the following parameters: · CashStockId must be the ID of the CashStock of the branch. · CashStockSessionTypeName must be “BRANCH”. · Employee data of the employee handle the cash via EBE. o EmployeeRobiId must be BNPPF Employee Identifier in the BNPPF Robi referential o EmployeeLastName must be family name of the employee o EmployeeFirstName must be first (or given) name of the employee · List of Cash Unit Stock o CashUnitStockQuantity must be the number of CashUnits. o CashUnitId must be the ID of the CashUnit. · Cash Stock Operation o CashStockOperationTypeName must be “CASH_STOCK_OPEN_WITH_CORRECTION”. o CashStockOperationComment is optional, maximum value will be 320 characters. o CashStockOperationAmount must be the total amount counted in cent (1€ = 100). · List of Cash Difference o CashDifferenceTypeName must be “DEFICIT” or “EXCESS”. o CashDifferenceReasonTypeName must be "TRANSACTIONAL" or "TRANSACTIONAL_RECUPERATION" or "UNIDENTIFIED_FUNDS" or "TECHNICAL_OPERATIONAL" o CashDifferenceAmount must be the amount in cent (1€ = 100). o NftNumber must be follow the right pattern depending on the CashDifferenceReasonTypeName. o CashDifferenceJustificationText is optional, maximum value will be 320 characters. [Exception flow E1: Input data validation fails]

2 KASH-ta02 validates the parameters receives: 1. CashStockId must exist. 2. CashStockStatusName of the CashStockId provided must be “CLOSE”. 3. CashUnitId provided must exist. 4. CashUnitId provided must be unique. 5. The total amount reflected in the Cash Unit Stock list must correspond to the CashStockOperationAmount. 6. The list of Cash Unit Stock provided must contain the same Cash Unit registered in the last Cash Stock Session and the stage of the Cash Unit Stock. 7. CashDifferenceTypeName and CashDifferenceReasonTypeName must be allowed for this CashStockOperationTypeName as specified in Technical Association Table of Cash Stock Operation with Cash Difference Type.

8. NftNumber received must be in a valid regex format as specified in Technical Mapping Table of Cash Difference Type with Validations Rules. 9. The additions of the CashStockOperationAmount and the CashDifferenceAmount received must be the total of the CashStockAmount registered in the Cash Stock 10. The Cash Difference list cannot exceed 50 items. [Exception flow E2: Functional validation fails]

3 KASH-ta02 validates that the CashStockSessionStatusName of last Cash Stock Session registered for the CashStockId isn’t “OPEN”. [Exceptional Flow: E3: Exist Cash Stock Session with CashStockSessionStatusName with “OPEN”]

4 KASH-ta02 put in place a mechanism to avoid multiple access to the same Cash Stock [Exception Flow #E12: Multiple access to CashStock Open]

5 KASH-ta02 creates a new Cash Stock Session with the following parameters: · CashStockSessionTypeName must be “BRANCH”. · Employee data of the employee handle the cash via EBE. o EmployeeRobiId o EmployeeLastName o EmployeeFirstName · CashStockSessionStatusName must be “OPEN” · CashStockSessionOpenDatetime must be the current datetime.

6 KASH-ta02 updates the Cash Stock with the following parameters: · Update the CashStockStatusName from “CLOSE” to ”OPEN” · Update the CashStockLastSessionId with the value of the step 5.

7 KASH-ta02 creates a new Cash Stock Operation with the following parameters: · CashStockSessionID with the value of the step 5. · CashStockID with the value receives in step 1. · CashStockOperationTypeName with the value “CASH_STOCK_OPEN”. · CashStockOperationComment with the value receives in step 1. · CashStockOperationStatusName with the value “EXECUTED”. · CashStockOperationAmount with the value receives in step 1. · CashStockOperationCurrency must be “EUR” · CashStockOperationCreationDatetime must be current datetime. · EmployeeRobigId with the value receives in step 1. · EmployeeLastName with the value receives in step 1. · EmployeeFirstName with the value receives in step 1.

8 KASH-ta02 creates new Cash Unit Stock in stage "OPENED" with list of Cash Unit Stock received.

9 KASH-ta02 creates a new copy of Cash Unit Stock in stage "OPENED" of step 8 with a stage "WORKING".

10 KASH-ta02 updates the CashStockSessionLastStageName to “WORKING” for the Cash Stock Session created in step 5.

11 KASH-ta02 updates CashStockAmount of Cash Stock to amount received in CashStockOperationAmount of the step 1.

12 KASH-ta02 creates a Cash Stock Operation with the following parameters: · CashStockSessionID with the value of the step 5. · CashStockID with the value receives in step 1. · CashStockOperationTypeName with the value “CASH_STOCK_CORRECTION”. · CashStockOperationComment with the value receives in step 1. · CashStockOperationStatusName with the value “EXECUTED”. · CashStockOperationAmount with the sum of the CashDifferenceAmount value receives in step 1. · CashStockOperationCurrency must be “EUR”. · CashStockOperationCreationDatetime must be current datetime. · EmployeeRobigId with the value receives in step 1. · EmployeeLastName with the value receives in step 1. · EmployeeFirstName with the value receives in step 1.

13 For each Cash Difference received in steps 1, create a Cash Difference with the following parameters: · CashStockOperationId with the value of the step 12 (link to the CASH_STOCK_CORRECTION previously created). · CashDifferenceStatusName with the value “EXECUTED”. · CashDifferenceTypeName with the value receives in step 1. · CashDifferenceReasonTypeName with the value receives in step 1. · CashDifferenceAmount with the value receives in step 1. · CashDifferenceAmountCurrencyCode must be “EUR”

· NftNumber with the value receives in step 1. · CashDifferenceJustificationText with the value receives in step 1.

14 KASH-ta02 calls MainFrame routine FCNSIA01 to register the Cash Difference on SI with the following mapping : · unitId with UnitRobiId of Cash Stock receives in step 1. · cashDifferenceTransactionCode with the value of SI Transaction Code store in database corresponding of the CashDifferenceTypeName and CashDifferenceReasonTypeName receives in step 1. · cashDifferencePetCode with the value of SI PET Code store in database corresponding of the CashDifferenceTypeName and CashDifferenceReasonTypeName receives in step 1. · cashDifferenceAmount with the value of CashDifferenceAmount receives in step 1. · cashDifferenceAmountCurrencyCode with the value “EUR”. · nftNumber with the value of NftNumberreceives in step 1. · nbo with an empty value. · tnum with an empty value. [Exception flow Exx: Cash Difference Not Well Registered in FC] à rollback of previous steps + response with a proper error message.

15 KASH-ta02 retrieved in the database and returns the response with the following information: · CashStockId · CashStockSessionId · CashStockOperationId · CashStockOperationStatusName · List of Cash Difference o CashDifferenceTypeName o CashDifferenceReasonTypeName o CashDifferenceAmount o CashDifferenceAmountCurrencyCode o NftNumber o CashDifferenceJustificationText o CashDifferenceStatusName o CashDifferenceCreationDatetime o PETCode
